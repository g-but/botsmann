#!/usr/bin/env sh

# Lint-staged
npx lint-staged

# Basic secrets scan on staged files only (lightweight patterns). Exit non-zero on match.
# Only matches full keys (30+ chars), not truncated doc examples like "eyJhbGci..."
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null | grep -v '\.env' | grep -v 'node_modules' || true)
if [ -n "$STAGED_FILES" ]; then
  if echo "$STAGED_FILES" | xargs -r rg -l "(SUPABASE_SERVICE_ROLE_KEY=\"eyJ[A-Za-z0-9_-]{50,}\"|NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJ[A-Za-z0-9_-]{50,}|GROQ_API_KEY=gsk_[A-Za-z0-9]{30,}|NEXT_AWS_SECRET_ACCESS_KEY=\"[A-Za-z0-9/+]{30,}\"|VERCEL_OIDC_TOKEN=eyJ[A-Za-z0-9_-]{100,}|SUPABASE_ACCESS_TOKEN=sbp_[A-Za-z0-9]{30,})" 2>/dev/null; then
    echo "\n[SECURITY] Potential secret detected in staged files. Commit aborted." >&2
    exit 1
  fi
fi

exit 0
